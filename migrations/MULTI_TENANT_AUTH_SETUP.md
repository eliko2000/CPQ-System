# Multi-Tenant Authentication - Supabase Auth Setup Guide

This document provides step-by-step instructions for configuring Supabase Auth for the multi-tenant CPQ system.

## Prerequisites

- Supabase project created
- Database migrations `multi-tenant-auth-001` through `multi-tenant-auth-005` executed successfully
- Admin access to Supabase Dashboard

## Step 1: Enable Email Authentication

1. Navigate to your Supabase project dashboard
2. Go to **Authentication** → **Providers**
3. Find **Email** provider and click to configure
4. Enable the following settings:
   - ✅ **Enable Email provider**
   - ✅ **Confirm email** (recommended for production)
   - ✅ **Secure email change** (recommended)
   - ✅ **Secure password change** (recommended)

## Step 1.5: Enable Azure AD (Microsoft) Authentication

### A. Register Application in Azure Portal

1. Go to [Azure Portal](https://portal.azure.com)
2. Navigate to **Microsoft Entra ID** (formerly Azure Active Directory)
3. Click **App registrations** → **New registration**
4. Configure the registration:
   - **Name**: `CPQ System` (or your preferred name)
   - **Supported account types**:
     - Choose **Accounts in this organizational directory only** (Single tenant) for company-only access
     - Or **Accounts in any organizational directory** (Multi-tenant) for broader access
   - **Redirect URI**:
     - Platform: **Web**
     - URL: `https://YOUR_SUPABASE_PROJECT_REF.supabase.co/auth/v1/callback`
     - (Get your project ref from Supabase Dashboard → Settings → API)
5. Click **Register**

### B. Configure Application Settings

1. After registration, note down:
   - **Application (client) ID** - you'll need this for Supabase
   - **Directory (tenant) ID** - you'll need this for Supabase

2. Go to **Certificates & secrets**:
   - Click **New client secret**
   - Description: `Supabase Auth`
   - Expires: Choose appropriate expiration (12 months, 24 months, or never)
   - Click **Add**
   - **Copy the secret value immediately** (you won't be able to see it again)

3. Go to **API permissions**:
   - Click **Add a permission**
   - Select **Microsoft Graph**
   - Select **Delegated permissions**
   - Add the following permissions:
     - `openid`
     - `profile`
     - `email`
     - `User.Read`
   - Click **Add permissions**
   - Click **Grant admin consent** (if you have admin rights)

4. Go to **Authentication**:
   - Under **Implicit grant and hybrid flows**, enable:
     - ✅ **ID tokens** (used for implicit and hybrid flows)
   - Under **Advanced settings**:
     - Set **Allow public client flows** to **No**

### C. Configure Azure Provider in Supabase

1. Go to your Supabase Dashboard
2. Navigate to **Authentication** → **Providers**
3. Find **Azure** provider and click to configure
4. Enable and configure:
   - ✅ **Enable Azure provider**
   - **Azure Tenant ID**: Paste your Directory (tenant) ID from Azure
   - **Azure Client ID**: Paste your Application (client) ID from Azure
   - **Azure Secret**: Paste the client secret value you copied earlier
   - **Redirect URL**: This is auto-generated by Supabase, copy it if you need to update Azure

5. Click **Save**

### D. Test Azure Authentication

1. The login page will automatically show a "Sign in with Microsoft" button
2. Users can click it to authenticate with their Microsoft/Azure AD accounts
3. After successful authentication:
   - User profile will be auto-created in `user_profiles` table
   - Email will be populated from Azure AD
   - User will be prompted to create or join a team

### E. Azure AD User Mapping

When a user signs in with Azure AD:

- **Email**: Mapped from Azure AD email
- **Full Name**: Mapped from Azure AD display name
- **Avatar**: Can be fetched from Microsoft Graph API (optional enhancement)

### F. Domain-Based Team Matching

You can configure teams with email domains to automatically match Azure AD users:

```sql
-- Example: Create a team for company.com domain
INSERT INTO teams (name, slug, email_domain)
VALUES ('Company Team', 'company-team', 'company.com');
```

When a user with email `user@company.com` signs up via Azure AD, they can be automatically suggested to join the "Company Team".

## Step 2: Configure Auth Settings

1. Go to **Authentication** → **Settings**
2. Configure the following:

### Site URL

- **Development**: `http://localhost:5173`
- **Production**: Your production domain (e.g., `https://cpq.yourcompany.com`)

### Redirect URLs

Add the following URLs (comma-separated):

```
http://localhost:5173/auth/callback,
http://localhost:5173,
https://your-production-domain.com/auth/callback,
https://your-production-domain.com
```

### Session Settings

- **JWT Expiry**: `604800` (7 days in seconds)
- **Refresh Token Rotation**: ✅ Enabled (recommended)
- **Reuse Interval**: `10` seconds

### Security Settings

- **Enable Captcha**: ❌ Disabled for development, ✅ Enabled for production
- **Rate Limiting**: ✅ Enabled (recommended)

## Step 3: Customize Email Templates

1. Go to **Authentication** → **Email Templates**
2. Customize the following templates:

### Confirm Signup Email

```html
<h2>Confirm your signup</h2>
<p>
  Welcome to CPQ System! Please confirm your email address by clicking the link
  below:
</p>
<p><a href="{{ .ConfirmationURL }}">Confirm your email</a></p>
<p>If you didn't create an account, you can safely ignore this email.</p>
```

### Reset Password Email

```html
<h2>Reset your password</h2>
<p>You requested to reset your password for CPQ System.</p>
<p><a href="{{ .ConfirmationURL }}">Reset your password</a></p>
<p>If you didn't request this, you can safely ignore this email.</p>
<p>This link expires in 1 hour.</p>
```

### Magic Link Email (Optional)

```html
<h2>Your magic link</h2>
<p>Click the link below to sign in to CPQ System:</p>
<p><a href="{{ .ConfirmationURL }}">Sign in</a></p>
<p>If you didn't request this, you can safely ignore this email.</p>
<p>This link expires in 1 hour.</p>
```

### Invite User Email (Optional)

```html
<h2>You've been invited to join a team</h2>
<p>You've been invited to join {{ .TeamName }} on CPQ System.</p>
<p><a href="{{ .ConfirmationURL }}">Accept invitation</a></p>
<p>If you don't want to join, you can safely ignore this email.</p>
```

## Step 4: Configure Environment Variables

Add the following to your `.env.local` file:

```env
# Supabase Configuration (already exists)
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key

# System Admin Emails (comma-separated)
VITE_SYSTEM_ADMIN_EMAILS=your-email@company.com,admin@company.com
```

## Step 5: Set System Admin Status

After the first user signs up, you need to manually set them as a system admin:

1. Go to **SQL Editor** in Supabase Dashboard
2. Run the following query (replace with your email):

```sql
UPDATE user_profiles
SET is_system_admin = true
WHERE email = 'your-email@company.com';
```

3. Verify the update:

```sql
SELECT id, email, is_system_admin
FROM user_profiles
WHERE is_system_admin = true;
```

## Step 6: Test Authentication Flow

### Test Signup

1. Navigate to `http://localhost:5173/signup`
2. Create a new account with email and password
3. Check your email for confirmation link
4. Click confirmation link
5. Verify user profile was created:

```sql
SELECT * FROM user_profiles WHERE email = 'test@example.com';
```

### Test Login

1. Navigate to `http://localhost:5173/login`
2. Sign in with your credentials
3. Verify session is created and user is redirected to dashboard

### Test Team Creation

1. After login, user should be prompted to create or join a team
2. Create a new team
3. Verify team and team membership were created:

```sql
SELECT t.name, tm.role
FROM teams t
JOIN team_members tm ON t.id = tm.team_id
JOIN user_profiles up ON tm.user_id = up.id
WHERE up.email = 'test@example.com';
```

## Step 7: Production Checklist

Before deploying to production:

**General Settings:**

- [ ] Update Site URL to production domain
- [ ] Update Redirect URLs to include production domain
- [ ] Enable email confirmation
- [ ] Enable Captcha protection
- [ ] Configure rate limiting
- [ ] Set system admin emails in environment variables

**Email Authentication:**

- [ ] Customize email templates with company branding
- [ ] Set up custom SMTP (optional, for branded emails)

**Azure AD Authentication:**

- [ ] Update Azure App Registration redirect URI to production URL
- [ ] Verify API permissions are granted
- [ ] Test Azure AD login flow in production
- [ ] Configure email domain matching for teams (if using single-tenant Azure AD)
- [ ] Set appropriate token expiration in Azure AD

**Testing:**

- [ ] Test complete signup → login → team creation flow (email)
- [ ] Test Azure AD login → team creation flow
- [ ] Verify RLS policies are working correctly
- [ ] Test feature flag system
- [ ] Test team switching functionality
- [ ] Verify user can belong to multiple teams

## Troubleshooting

### Users can't sign up

- Check that Email provider is enabled
- Verify redirect URLs are correct
- Check browser console for errors

### Email confirmations not sending

- Verify email provider settings
- Check Supabase logs in Dashboard → Logs
- Ensure email templates are configured

### Azure AD login fails

- **Error: "Redirect URI mismatch"**
  - Verify the redirect URI in Azure App Registration matches Supabase's callback URL
  - Format should be: `https://YOUR_PROJECT_REF.supabase.co/auth/v1/callback`
- **Error: "AADSTS50011: Reply URL mismatch"**
  - Check that redirect URI is configured as **Web** platform, not SPA
  - Ensure there are no trailing slashes in the URL

- **Error: "AADSTS65001: User consent required"**
  - Admin needs to grant consent for API permissions in Azure Portal
  - Go to API permissions → Grant admin consent

- **Error: "Invalid client secret"**
  - Client secret may have expired
  - Generate a new client secret in Azure Portal → Certificates & secrets
  - Update the secret in Supabase Auth settings

- **Users can sign in but profile not created**
  - Check that `handle_new_user()` trigger is active
  - Verify Supabase logs for errors
  - Ensure email is being returned from Azure AD

### RLS policies blocking access

- Verify user is member of a team
- Check that team_id is being set correctly on queries
- Review RLS policies in SQL Editor

### Session expires too quickly

- Increase JWT Expiry in Auth Settings
- Enable Refresh Token Rotation
- Check Azure AD token lifetime settings

## Additional Resources

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Supabase Azure OAuth Guide](https://supabase.com/docs/guides/auth/social-login/auth-azure)
- [Row Level Security Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [Email Templates](https://supabase.com/docs/guides/auth/auth-email-templates)
- [Azure AD App Registration](https://learn.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app)
- [Microsoft Graph API Permissions](https://learn.microsoft.com/en-us/graph/permissions-reference)
