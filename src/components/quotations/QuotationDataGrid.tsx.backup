import React, { useRef, useState, useCallback, useMemo } from 'react'
import { AgGridReact } from 'ag-grid-react'
import { ColDef, GridReadyEvent, NewValueParams, ValueFormatterParams, ICellRendererParams, ICellEditorParams } from 'ag-grid-community'
import { useQuotations } from '../../hooks/useQuotations'
import { useCPQ } from '../../contexts/CPQContext'
import { DbQuotation } from '../../types'
import { Button } from '../ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '../ui/card'
import { Badge } from '../ui/badge'
import { ConfirmDialog } from '../ui/ConfirmDialog'
import { formatCurrency, convertDbQuotationToQuotationProject } from '../../lib/utils'
import { Edit, Trash2, Copy, Plus, Settings, ChevronDown } from 'lucide-react'
import { useClickOutside } from '../../hooks/useClickOutside'
import { useTableConfig } from '../../hooks/useTableConfig'
import { CustomHeader } from '../grid/CustomHeader'

import 'ag-grid-community/styles/ag-grid.css'
import 'ag-grid-community/styles/ag-theme-alpine.css'

// Custom cell renderer for status
const StatusRenderer = (params: ICellRendererParams) => {
  const status = params.value
  const statusConfig = {
    'draft': { label: 'טיוטה', className: 'bg-gray-100 text-gray-800' },
    'sent': { label: 'נשלחה', className: 'bg-blue-100 text-blue-800' },
    'accepted': { label: 'התקבלה', className: 'bg-green-100 text-green-800' },
    'rejected': { label: 'נדחתה', className: 'bg-red-100 text-red-800' },
    'expired': { label: 'פגה תוקף', className: 'bg-orange-100 text-orange-800' }
  }
  
  const config = statusConfig[status as keyof typeof statusConfig] || statusConfig.draft
  
  return (
    <Badge className={config.className}>
      {config.label}
    </Badge>
  )
}

// Custom cell renderer for currency
const CurrencyRenderer = (params: ValueFormatterParams) => {
  const value = params.value
  if (value == null) return '-'
  
  return (
    <span className="font-mono text-sm">
      ₪{value.toLocaleString('he-IL', { minimumFractionDigits: 2 })}
    </span>
  )
}

// Action context interface
interface ActionContext {
  onEdit: (data: DbQuotation) => void
  onDelete: (data: DbQuotation) => void
  onDuplicate: (data: DbQuotation) => void
  onNewVersion: (data: DbQuotation) => void
}

// Custom cell renderer for actions
const ActionsRenderer = (params: ICellRendererParams) => {
  const { onEdit, onDelete, onDuplicate, onNewVersion } = params.context as ActionContext
  
  return (
    <div className="flex gap-1">
      <Button
        variant="ghost"
        size="sm"
        onClick={() => onEdit(params.data)}
        className="h-8 w-8 p-0"
        title="ערוך"
      >
        <Edit className="h-3 w-3" />
      </Button>
      <Button
        variant="ghost"
        size="sm"
        onClick={() => onDuplicate(params.data)}
        className="h-8 w-8 p-0"
        title="שכפל"
      >
        <Copy className="h-3 w-3" />
      </Button>
      <Button
        variant="ghost"
        size="sm"
        onClick={() => onNewVersion(params.data)}
        className="h-8 w-8 p-0"
        title="גרסה חדשה"
      >
        <Plus className="h-3 w-3" />
      </Button>
      <Button
        variant="ghost"
        size="sm"
        onClick={() => onDelete(params.data)}
        className="h-8 w-8 p-0 text-red-600 hover:text-red-800"
        title="מחק"
      >
        <Trash2 className="h-3 w-3" />
      </Button>
    </div>
  )
}

interface QuotationDataGridProps {
  onQuotationSelect?: (quotation: DbQuotation) => void
  onQuotationEdit?: (quotation: DbQuotation) => void
}

export const QuotationDataGrid: React.FC<QuotationDataGridProps> = ({
  onQuotationSelect,
  onQuotationEdit
}) => {
  const { quotations, loading, error, updateQuotation, deleteQuotation, addQuotation, duplicateQuotation } = useQuotations()
  const { setCurrentQuotation } = useCPQ()
  
  const gridRef = useRef<AgGridReact>(null)
  const [selectedQuotations, setSelectedQuotations] = useState<string[]>([])
  const [deleteDialog, setDeleteDialog] = useState<{ open: boolean; quotation?: DbQuotation }>({ open: false })
  const [creatingNew, setCreatingNew] = useState(false)

  // Handle edit
  const handleEdit = useCallback((quotation: DbQuotation) => {
    if (onQuotationEdit) {
      onQuotationEdit(quotation)
    } else {
      // Convert DbQuotation to QuotationProject and open in editor
      const quotationProject = convertDbQuotationToQuotationProject(quotation)
      setCurrentQuotation(quotationProject)
    }
  }, [onQuotationEdit, setCurrentQuotation])

  // Handle delete
  const handleDelete = useCallback((quotation: DbQuotation) => {
    setDeleteDialog({ open: true, quotation })
  }, [])

  // Handle duplicate
  const handleDuplicate = useCallback(async (quotation: DbQuotation) => {
    try {
      const newQuotationNumber = `${quotation.quotation_number}-COPY-${Date.now()}`
      const newQuotation = await duplicateQuotation(quotation.id, newQuotationNumber)

      if (newQuotation) {
        const quotationProject = convertDbQuotationToQuotationProject(newQuotation)
        if (onQuotationEdit) {
          onQuotationEdit(newQuotation)
        } else {
          setCurrentQuotation(quotationProject)
        }
      }
    } catch (error) {
      console.error('Failed to duplicate quotation:', error)
      alert('שגיאה בשכפול הצעת מחיר. נסה שוב.')
    }
  }, [duplicateQuotation, onQuotationEdit, setCurrentQuotation])

  // Handle new version
  const handleNewVersion = useCallback(async (quotation: DbQuotation) => {
    try {
      const currentVersion = quotation.version || 1
      const newQuotationNumber = `${quotation.quotation_number}-V${currentVersion + 1}`
      const newQuotation = await duplicateQuotation(quotation.id, newQuotationNumber)

      if (newQuotation) {
        const quotationProject = convertDbQuotationToQuotationProject(newQuotation)
        if (onQuotationEdit) {
          onQuotationEdit(newQuotation)
        } else {
          setCurrentQuotation(quotationProject)
        }
      }
    } catch (error) {
      console.error('Failed to create new version:', error)
      alert('שגיאה ביצירת גרסה חדשה. נסה שוב.')
    }
  }, [duplicateQuotation, onQuotationEdit, setCurrentQuotation])

  // Create context for AG Grid cell renderers
  const gridContext = useMemo(() => ({
    onEdit: handleEdit,
    onDelete: handleDelete,
    onDuplicate: handleDuplicate,
    onNewVersion: handleNewVersion
  }), [handleEdit, handleDelete, handleDuplicate, handleNewVersion])

  // Convert DbQuotation to grid data format
  const gridData = useMemo(() => {
    return quotations.map(quotation => ({
      ...quotation,
      // Add computed fields for display
      displayTotalPrice: quotation.total_price || 0,
      displayTotalCost: quotation.total_cost || 0,
      displayMargin: quotation.total_price && quotation.total_cost 
        ? ((quotation.total_price - quotation.total_cost) / quotation.total_cost * 100)
        : 0
    }))
  }, [quotations])

  // Column definitions with RTL support - no pinning
  const columnDefs: ColDef[] = useMemo(() => [
    {
      headerName: 'מספר הצעה',
      field: 'quotation_number',
      width: 140,
      editable: false,
      filter: 'agTextColumnFilter'
    },
    {
      headerName: 'גרסה',
      field: 'version',
      width: 80,
      editable: true,
      cellEditor: 'agNumberCellEditor',
      cellEditorParams: {
        min: 1,
        precision: 0
      },
      valueFormatter: (params: ValueFormatterParams) => params.value?.toString() || '1'
    },
    {
      headerName: 'שם לקוח',
      field: 'customer_name',
      width: 180,
      editable: true,
      cellEditor: 'agTextCellEditor',
      filter: 'agTextColumnFilter'
    },
    {
      headerName: 'שם פרויקט',
      field: 'project_name',
      width: 200,
      editable: true,
      cellEditor: 'agTextCellEditor',
      filter: 'agTextColumnFilter'
    },
    {
      headerName: 'סטטוס',
      field: 'status',
      width: 120,
      editable: true,
      cellEditor: 'agSelectCellEditor',
      cellEditorParams: {
        values: ['draft', 'sent', 'accepted', 'rejected', 'expired']
      },
      cellRenderer: StatusRenderer,
      filter: 'agSetColumnFilter',
      filterParams: {
        values: ['draft', 'sent', 'accepted', 'rejected', 'expired']
      }
    },
    {
      headerName: 'מחיר סופי',
      field: 'displayTotalPrice',
      width: 130,
      editable: false,
      cellRenderer: CurrencyRenderer,
      valueGetter: (params) => params.data?.total_price || 0,
      filter: 'agNumberColumnFilter'
    },
    {
      headerName: 'עלות כוללת',
      field: 'displayTotalCost',
      width: 130,
      editable: false,
      cellRenderer: CurrencyRenderer,
      valueGetter: (params) => params.data?.total_cost || 0,
      filter: 'agNumberColumnFilter'
    },
    {
      headerName: 'תאריך יצירה',
      field: 'created_at',
      width: 120,
      valueFormatter: (params: ValueFormatterParams) => {
        if (!params.value) return '-'
        return new Date(params.value).toLocaleDateString('he-IL')
      },
      filter: 'agDateColumnFilter',
      comparator: (dateA: string, dateB: string) => {
        return new Date(dateA).getTime() - new Date(dateB).getTime()
      }
    },
    {
      headerName: 'תאריך עדכון',
      field: 'updated_at',
      width: 120,
      valueFormatter: (params: ValueFormatterParams) => {
        if (!params.value) return '-'
        return new Date(params.value).toLocaleDateString('he-IL')
      },
      filter: 'agDateColumnFilter',
      comparator: (dateA: string, dateB: string) => {
        return new Date(dateA).getTime() - new Date(dateB).getTime()
      }
    },
    {
      headerName: 'פעולות',
      field: 'actions',
      width: 160,
      sortable: false,
      filter: false,
      cellRenderer: ActionsRenderer
    }
  ], [])

  // Handle cell value changes
  const handleCellValueChanged = useCallback(async (params: NewValueParams) => {
    const { data, colDef, newValue, oldValue } = params
    
    if (newValue === oldValue) return

    try {
      await updateQuotation(data.id, {
        [colDef.field!]: newValue
      })
    } catch (error) {
      console.error('Failed to update quotation:', error)
      // Revert change in grid
      if (params.node) {
        params.node.setDataValue(colDef.field!, oldValue)
      }
    }
  }, [updateQuotation])

  // Confirm delete
  const confirmDelete = useCallback(async () => {
    if (!deleteDialog.quotation) return

    try {
      await deleteQuotation(deleteDialog.quotation.id)
      setDeleteDialog({ open: false })
    } catch (error) {
      console.error('Failed to delete quotation:', error)
    }
  }, [deleteDialog.quotation, deleteQuotation])

  // Handle row double click
  const handleRowDoubleClicked = useCallback((params: any) => {
    if (onQuotationSelect) {
      onQuotationSelect(params.data)
    } else {
      // Convert and open in editor
      const quotationProject = convertDbQuotationToQuotationProject(params.data)
      setCurrentQuotation(quotationProject)
    }
  }, [onQuotationSelect, setCurrentQuotation])

  // Handle selection change
  const handleSelectionChanged = useCallback(() => {
    const selectedNodes = gridRef.current?.api.getSelectedNodes() || []
    setSelectedQuotations(selectedNodes.map((node: any) => node.data.id))
  }, [])

  // Grid ready handler
  const onGridReady = useCallback((params: GridReadyEvent) => {
    params.api.sizeColumnsToFit()
  }, [])

  // Add new quotation
  const handleAddNew = useCallback(async () => {
    if (creatingNew) return

    setCreatingNew(true)
    try {
      const newQuotation = await addQuotation({
        quotation_number: `Q-${Date.now()}`,
        customer_name: 'לקוח חדש',
        project_name: 'פרויקט חדש',
        currency: 'ILS',
        exchange_rate: 3.7,
        margin_percentage: 25,
        status: 'draft',
        total_cost: 0,
        total_price: 0
      })

      if (newQuotation) {
        const quotationProject = convertDbQuotationToQuotationProject(newQuotation)
        if (onQuotationEdit) {
          onQuotationEdit(newQuotation)
        } else {
          setCurrentQuotation(quotationProject)
        }
      }
    } catch (error) {
      console.error('Failed to create quotation:', error)
    } finally {
      setCreatingNew(false)
    }
  }, [addQuotation, onQuotationEdit, setCurrentQuotation, creatingNew])

  // Calculate summary statistics
  const summaryStats = useMemo(() => {
    const totalValue = quotations.reduce((sum, q) => sum + (q.total_price || 0), 0)
    const totalCost = quotations.reduce((sum, q) => sum + (q.total_cost || 0), 0)
    const totalMargin = totalValue - totalCost
    const avgMargin = totalCost > 0 ? (totalMargin / totalCost) * 100 : 0

    const statusCounts = quotations.reduce((acc, q) => {
      acc[q.status] = (acc[q.status] || 0) + 1
      return acc
    }, {} as Record<string, number>)

    return {
      totalValue,
      totalCost,
      totalMargin,
      avgMargin,
      statusCounts,
      totalCount: quotations.length
    }
  }, [quotations])

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-lg">טוען נתונים...</div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-lg text-red-600">שגיאה: {error}</div>
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">הצעות מחיר</h1>
          <p className="text-gray-600">ניהול ועריכה של הצעות מחיר</p>
        </div>
        <Button
          onClick={handleAddNew}
          disabled={creatingNew}
          className="bg-blue-600 hover:bg-blue-700"
        >
          <Plus className="h-4 w-4 ml-2" />
          {creatingNew ? 'יוצר...' : 'הצעת מחיר חדשה'}
        </Button>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <Card>
          <CardContent className="p-4">
            <div className="text-sm font-medium text-gray-600">סה"כ הצעות</div>
            <div className="text-2xl font-bold">{summaryStats.totalCount}</div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="p-4">
            <div className="text-sm font-medium text-gray-600">שווי כולל</div>
            <div className="text-2xl font-bold text-blue-600">
              {formatCurrency(summaryStats.totalValue)}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="p-4">
            <div className="text-sm font-medium text-gray-600">עלות כוללת</div>
            <div className="text-2xl font-bold text-orange-600">
              {formatCurrency(summaryStats.totalCost)}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="p-4">
            <div className="text-sm font-medium text-gray-600">רווח כולל</div>
            <div className="text-2xl font-bold text-green-600">
              {formatCurrency(summaryStats.totalMargin)}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="p-4">
            <div className="text-sm font-medium text-gray-600">רווח ממוצע</div>
            <div className="text-2xl font-bold">
              {summaryStats.avgMargin.toFixed(1)}%
            </div>
          </CardContent>
        </Card>
      </div>

      {/* AG Grid */}
      <Card>
        <CardHeader>
          <CardTitle>רשימת הצעות מחיר</CardTitle>
          <div className="text-sm text-gray-600">
            {selectedQuotations.length > 0 && `נבחרו ${selectedQuotations.length} הצעות`}
          </div>
        </CardHeader>
        <CardContent>
          <div className="ag-theme-alpine" style={{ height: '600px', width: '100%', direction: 'rtl' }}>
            <AgGridReact
              ref={gridRef}
              rowData={gridData}
              columnDefs={columnDefs}
              context={gridContext}
              enableRtl={true}
              defaultColDef={{
                sortable: true,
                filter: true,
                resizable: true,
                floatingFilter: false
              }}
              onGridReady={onGridReady}
              onCellValueChanged={handleCellValueChanged}
              onRowDoubleClicked={handleRowDoubleClicked}
              onSelectionChanged={handleSelectionChanged}
              rowSelection="multiple"
              enableRangeSelection={false}
              animateRows={true}
              editType="fullRow"
              stopEditingWhenCellsLoseFocus={true}
              suppressClickEdit={true}
              singleClickEdit={true}
              pagination={true}
              paginationPageSize={50}
              paginationPageSizeSelector={[25, 50, 100, 200]}
            />
          </div>
        </CardContent>
      </Card>

      {/* Delete Confirmation Dialog */}
      <ConfirmDialog
        isOpen={deleteDialog.open}
        title="מחיקת הצעת מחיר"
        message={`האם אתה בטוח שברצונך למחוק את הצעת המחיר "${deleteDialog.quotation?.project_name || deleteDialog.quotation?.quotation_number}"?`}
        confirmText="מחק"
        cancelText="ביטול"
        onConfirm={confirmDelete}
        onCancel={() => setDeleteDialog({ open: false })}
        type="danger"
      />
    </div>
  )
}
